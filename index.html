<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>EnergyPlus eplusout.sql â€” Offline Dashboard</title>
    <script src="dist/version.js"></script>
    <script>
      try {
        var k = 'eplus_theme';
        var s = localStorage.getItem(k);
        var t =
          s === 'light' || s === 'dark'
            ? s
            : matchMedia('(prefers-color-scheme: dark)').matches
              ? 'dark'
              : 'light';
        document.documentElement.setAttribute('data-theme', t);
      } catch (e) {
        document.documentElement.setAttribute('data-theme', 'light');
      }
    </script>
    <!-- Tailwind CSS compiled locally -->
    <link rel="stylesheet" href="dist/tailwind.css" />
    <!-- Removed legacy CSS variables; using Tailwind semantic classes -->
    <script>
      // Prefer local vendor copies (built into dist/vendor via build script); fall back to CDN if missing.
      window.__LIB_URLS__ = {
        d3: 'dist/vendor/d3.min.js',
        sqljs: 'dist/vendor/sql-wasm.js',
        sqlwasm: 'dist/vendor/sql-wasm.wasm',
      };
    </script>
  </head>
  <body
    class="h-screen flex flex-col bg-bg text-text dark:bg-bg-dark dark:text-text-dark transition-colors"
  >
    <header
      class="px-4 py-3 border-b border-border dark:border-border-dark sticky top-0 z-10 backdrop-blur-sm bg-white/95 dark:bg-[#121821]/90"
    >
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div class="flex flex-col flex-1 min-w-0">
          <h1 class="text-base font-semibold tracking-wide truncate flex items-baseline gap-2">
            <span>EnergyPlus eplusout.sql Dashboard</span>
            <button
              id="app-version"
              type="button"
              class="text-[11px] font-mono text-muted dark:text-muted-dark hover:text-text dark:hover:text-text-dark underline decoration-dotted focus:outline-none focus:ring-2 focus:ring-accent dark:focus:ring-accent-dark rounded"
              aria-haspopup="dialog"
              aria-controls="changelog-modal"
            ></button>
          </h1>
          <span class="text-xs text-muted dark:text-muted-dark"
            >Drop
            <span class="px-1 py-0.5 rounded bg-code dark:bg-code-dark">eplusout.sql</span>
            to explore variables & meters.</span
          >
        </div>
        <div class="flex flex-nowrap gap-2 overflow-x-auto items-center">
          <button
            id="btn-open"
            type="button"
            class="px-2.5 py-1.5 text-sm shrink-0 border rounded bg-panel dark:bg-panel-dark border-border dark:border-border-dark hover:bg-panel-2 dark:hover:bg-panel-2-dark"
            title="Open eplusout.sql"
          >
            Open eplusout.sql
          </button>
          <button
            id="btn-report"
            type="button"
            class="px-2.5 py-1.5 text-sm shrink-0 border rounded bg-panel dark:bg-panel-dark border-border dark:border-border-dark hover:bg-panel-2 dark:hover:bg-panel-2-dark"
            aria-label="Report a bug or request a feature"
            title="Report a bug or request a feature"
          >
            Report issue
          </button>
          <button
            id="btn-export"
            type="button"
            disabled
            class="px-3 py-1.5 text-sm rounded-md border disabled:opacity-50 disabled:cursor-not-allowed text-white bg-accent-strong dark:bg-accent-strong-dark border-accent-strong dark:border-accent-strong-dark"
          >
            Export CSV
          </button>
          <button
            id="btn-html-report"
            type="button"
            disabled
            aria-label="View HTML Report"
            title="View HTML Report"
            class="px-2.5 py-1.5 text-sm shrink-0 border rounded disabled:opacity-50 disabled:cursor-not-allowed bg-panel dark:bg-panel-dark border-border dark:border-border-dark hover:bg-panel-2 dark:hover:bg-panel-2-dark"
          >
            <!-- Document report icon -->
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              class="size-6"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 0 1-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-7.5A1.125 1.125 0 0 1 12 18.375m9.75-12.75c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125m19.5 0v1.5c0 .621-.504 1.125-1.125 1.125M2.25 5.625v1.5c0 .621.504 1.125 1.125 1.125m0 0h17.25m-17.25 0h7.5c.621 0 1.125.504 1.125 1.125M3.375 8.25c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m17.25-3.75h-7.5c-.621 0-1.125.504-1.125 1.125m8.625-1.125c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125M12 10.875v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 10.875c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125M13.125 12h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125M20.625 12c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5M12 14.625v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 14.625c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125m0 1.5v-1.5m0 0c0-.621.504-1.125 1.125-1.125m0 0h7.5"
              />
            </svg>
          </button>
          <button
            id="btn-theme"
            type="button"
            aria-label="Toggle dark mode"
            title="Toggle dark mode"
            class="px-2.5 py-1.5 text-sm shrink-0 border rounded bg-panel dark:bg-panel-dark border-border dark:border-border-dark hover:bg-panel-2 dark:hover:bg-panel-2-dark"
          >
            <!-- Heroicons Sun (outline) shown in light mode -->
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              class="w-5 h-5 dark:hidden"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 3v2.25M12 18.75V21M4.5 12H2.25M21.75 12H19.5M6.364 6.364l-1.59-1.59M19.227 19.227l-1.59-1.59M6.364 17.636l-1.59 1.59M19.227 4.773l-1.59 1.59M16.5 12a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0z"
              />
            </svg>
            <!-- Heroicons Moon (outline) shown in dark mode -->
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              class="w-5 h-5 hidden dark:inline"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"
              />
            </svg>
          </button>
          <button
            id="btn-units"
            type="button"
            aria-label="Toggle units"
            title="Toggle SI/IP units"
            class="px-2.5 py-1.5 text-sm shrink-0 border rounded bg-panel dark:bg-panel-dark border-border dark:border-border-dark hover:bg-panel-2 dark:hover:bg-panel-2-dark"
          >
            SI
          </button>
          <button
            id="btn-units-settings"
            type="button"
            aria-label="Unit settings"
            title="Unit settings"
            class="px-2.5 py-1.5 text-sm shrink-0 border rounded bg-panel dark:bg-panel-dark border-border dark:border-border-dark hover:bg-panel-2 dark:hover:bg-panel-2-dark"
          >
            <!-- Heroicons Cog 6 Tooth -->
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              class="w-5 h-5"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.326.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128 1.125 1.125 0 00-.645.87l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281a1.125 1.125 0 00-.645-.87 6.52 6.52 0 01-.22-.128c-.326-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.75.072 1.076-.124.072-.044.146-.087.22-.128.332-.184.582-.496.645-.87l.214-1.281z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
              />
            </svg>
          </button>
        </div>
      </div>
    </header>

    <!-- Open Database Modal -->
<!-- Open Database Modal -->
<div
  id="open-backdrop"
  class="hidden fixed inset-0 bg-black/40 dark:bg-black/60 backdrop-blur-sm z-40"
></div>
<div
  id="open-modal"
  class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
  role="dialog"
  aria-modal="true"
  aria-labelledby="open-title"
>
  <div
    class="w-[min(96vw,56rem)] aspect-square max-h-[90vh] rounded-lg border border-border dark:border-border-dark bg-panel dark:bg-panel-dark shadow-xl flex flex-col"
  >
    <div
      class="flex justify-between items-center px-4 py-3 border-b border-border dark:border-border-dark"
    >
      <h2 id="open-title" class="text-base font-semibold">Open eplusout.sql</h2>
      <button
        id="open-close"
        class="text-sm px-2 py-1 border rounded bg-panel-2 dark:bg-panel-2-dark border-border dark:border-border-dark"
      >
        Close
      </button>
    </div>
    <div class="p-4 flex flex-col gap-4 flex-1 overflow-hidden">
      <div
        id="open-drop"
        class="flex-1 min-h-[12rem] text-center border-2 border-dashed rounded-md border-border dark:border-border-dark bg-panel-2/40 dark:bg-panel-2-dark/40 overflow-hidden"
      >
        <label
          for="file-input"
          class="block w-full h-full grid place-items-center cursor-pointer select-none"
        >
          <div>
            <div class="text-sm font-medium mb-1">Drag & drop your eplusout.sql here</div>
            <div class="text-xs text-muted dark:text-muted-dark">or click to choose a file</div>
          </div>
        </label>
        <input id="file-input" type="file" accept=".sql,.sqlite,.db" class="hidden" />
      </div>
      <div class="mt-0 flex items-center justify-between">
        <div class="text-xs text-muted dark:text-muted-dark">Accepted: .sql, .sqlite, .db</div>
        <button
          id="open-load-sample"
          type="button"
          class="px-2.5 py-1.5 text-sm shrink-0 border rounded bg-panel dark:bg-panel-dark border-border dark:border-border-dark hover:bg-panel-2 dark:hover:bg-panel-2-dark"
        >
          Load Sample
        </button>
      </div>
    </div>
  </div>
</div>


    <main
      id="main-grid"
      class="grid grid-cols-1 lg:grid-cols-[360px_12px_1fr] gap-3 lg:gap-0 p-2 sm:p-3 flex-1 overflow-auto"
    >
      <section
        id="signals-panel"
        class="flex flex-col rounded-lg border border-border dark:border-border-dark bg-panel dark:bg-panel-dark overflow-hidden min-h-0 order-1 lg:order-none z-0"
      >
        <div
          class="flex justify-between items-center px-3 py-2 border-b border-border dark:border-border-dark bg-panel-2 dark:bg-panel-2-dark"
        >
          <div class="flex items-center gap-2">
            <strong>Signals</strong
            ><span id="meta-count" class="text-muted dark:text-muted-dark"></span>
          </div>
          <!-- Collapse toggle removed -->
        </div>
        <div id="signals-body" class="p-3 flex flex-col gap-2 overflow-auto">
          <input
            type="text"
            id="search"
            placeholder="Search name/group/key/unitsâ€¦"
            disabled
            class="w-full border rounded px-2 py-1 bg-panel-2 dark:bg-panel-2-dark border-border dark:border-border-dark"
          />
          <label class="flex items-center gap-2 text-xs text-muted dark:text-muted-dark select-none"
            ><input id="fav-only" type="checkbox" class="h-3.5 w-3.5" />
            <span>Favorites only (doubleâ€‘click items to â˜…/â˜†)</span></label
          >
          <div class="flex gap-2">
            <select
              id="filter-freq"
              disabled
              class="w-full border rounded px-2 py-1 bg-panel-2 dark:bg-panel-2-dark border-border dark:border-border-dark"
            >
              <option value="">Any frequency</option>
              <option value="Hourly">Hourly</option>
              <option value="Monthly">Monthly</option>
            </select>
            <select
              id="filter-meter"
              disabled
              class="w-full border rounded px-2 py-1 bg-panel-2 dark:bg-panel-2-dark border-border dark:border-border-dark"
            >
              <option value="">Vars & Meters</option>
              <option value="1">Meters only</option>
              <option value="0">Variables only</option>
            </select>
          </div>
          <select
            id="filter-group"
            disabled
            class="w-full border rounded px-2 py-1 bg-panel-2 dark:bg-panel-2-dark border-border dark:border-border-dark"
          >
            <option value="">Any index group</option>
          </select>
          <select
            id="dictionary"
            size="12"
            multiple
            class="w-full border rounded px-2 py-1 bg-panel-2 dark:bg-panel-2-dark border-border dark:border-border-dark min-h-[240px]"
            disabled
          ></select>
          <div class="text-xs text-muted dark:text-muted-dark mt-2">
            Tip: Choose an entry to plot. Hourly â†’ line; Monthly â†’ bars.
          </div>
          <div id="zones-quick-wrap" class="mt-3 hidden">
            <div class="flex items-center justify-between mb-1">
              <strong class="text-xs">Zones</strong>
              <span
                id="zones-quick-count"
                class="text-[10px] text-muted dark:text-muted-dark"
              ></span>
            </div>
            <div id="zones-quick" class="flex flex-wrap gap-1.5"></div>
            <div id="zones-quick-hint" class="text-[10px] text-muted dark:text-muted-dark mt-1">
              Click a zone to load Temperature and Setpoints.
            </div>
          </div>
        </div>
      </section>

      <!-- Vertical resizer (visible on lg+) -->
      <div
        id="signals-resizer"
        class="hidden lg:block cursor-col-resize select-none touch-none"
        aria-hidden="true"
      >
        <div class="h-full w-px bg-border dark:bg-border-dark mx-auto"></div>
      </div>

      <section
        class="flex flex-col rounded-lg border border-border dark:border-border-dark bg-panel dark:bg-panel-dark overflow-hidden min-h-0 order-2 lg:order-none"
      >
        <div
          class="flex justify-between items-center px-3 py-2 border-b border-border dark:border-border-dark bg-panel-2 dark:bg-panel-2-dark"
        >
          <strong id="series-title">Series</strong
          ><span id="units" class="text-muted dark:text-muted-dark"></span>
        </div>
        <div class="p-3 flex flex-col gap-3 overflow-auto">
          <div id="series-meta" class="relative text-xs text-muted dark:text-muted-dark">
            <div id="series-meta-entries" class="grid grid-cols-[auto_1fr] gap-x-2 pr-10"></div>
          </div>
          <div class="flex items-center justify-between flex-wrap gap-2">
            <div class="flex items-center gap-3 flex-wrap">
              <div
                class="inline-flex rounded border border-border dark:border-border-dark overflow-hidden"
              >
                <button id="view-time" class="px-2 py-1 text-xs bg-panel-2 dark:bg-panel-2-dark">
                  Time Series
                </button>
                <button id="view-ldc" class="px-2 py-1 text-xs">Load Duration</button>
                <button id="view-balance" class="px-2 py-1 text-xs">Load Balance</button>
                <button id="view-scatter" class="px-2 py-1 text-xs">Scatter</button>
              </div>
              <label class="ml-1 text-xs inline-flex items-center gap-1">
                <input id="ldc-normalize" type="checkbox" class="align-middle" />
                Normalize to peak
              </label>
              <label class="ml-2 text-xs inline-flex items-center gap-1">
                Resolution:
                <select
                  id="resample-mode"
                  class="px-1 py-0.5 rounded bg-panel-2 dark:bg-panel-2-dark border border-border dark:border-border-dark text-xs"
                >
                  <option value="original">Original</option>
                  <option value="hourly">Hourly</option>
                  <option value="monthly">Monthly</option>
                  <option value="annual">Annual</option>
                </select>
              </label>
              <label class="ml-2 text-xs inline-flex items-center gap-1">
                Aggregation:
                <select
                  id="resample-agg"
                  class="px-1 py-0.5 rounded bg-panel-2 dark:bg-panel-2-dark border border-border dark:border-border-dark text-xs"
                >
                  <option value="auto">Auto</option>
                  <option value="sum">Sum</option>
                  <option value="avg">Avg</option>
                  <option value="max">Max</option>
                  <option value="min">Min</option>
                </select>
              </label>
            </div>
            <div
              class="flex items-center gap-2 ml-auto text-sm text-muted dark:text-muted-dark"
              id="toolbar-actions"
            >
              <!-- Zoom always enabled (button removed) -->
              <!-- tariff button will be injected here if present -->
            </div>
          </div>
          <div id="zoom-hint" class="text-xs text-muted dark:text-muted-dark hidden">
            Drag on the mini-map to zoom. Double-tap to reset.
          </div>
          <div id="single-chart-panel" class="flex flex-col gap-3">
            <div id="legend" class="flex flex-wrap gap-2 items-center"></div>
            <div
              id="insights"
              class="rounded-md border border-border dark:border-border-dark bg-panel-2 dark:bg-panel-2-dark p-3 text-sm"
            ></div>
            <div id="kpis" class="grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-6 gap-2"></div>
            <div
              id="chart"
              class="w-full h-[420px] max-[768px]:h-[300px] max-[480px]:h-[220px] relative"
            ></div>
            <div id="stats" class="grid grid-cols-8 gap-2"></div>
          </div>
          <div id="multi-charts" class="flex flex-col gap-4 hidden"></div>
        </div>
      </section>
    </main>

    <!-- Changelog Modal -->
    <div
      id="changelog-backdrop"
      class="hidden fixed inset-0 bg-black/40 dark:bg-black/60 backdrop-blur-sm z-40"
    ></div>
    <div
      id="changelog-modal"
      class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
      role="dialog"
      aria-modal="true"
      aria-labelledby="changelog-title"
      tabindex="-1"
    >
      <div
        class="w-[min(96vw,48rem)] h-[min(90vh,40rem)] rounded-lg border border-border dark:border-border-dark bg-panel dark:bg-panel-dark shadow-xl flex flex-col"
      >
        <div
          class="flex items-center justify-between px-4 py-3 border-b border-border dark:border-border-dark"
        >
          <h2 id="changelog-title" class="text-base font-semibold">What's New</h2>
          <button
            onclick="hideChangelog()"
            class="text-sm px-2 py-1 border rounded bg-panel-2 dark:bg-panel-2-dark border-border dark:border-border-dark"
          >
            Close
          </button>
        </div>
        <div
          id="changelog-body"
          class="p-4 flex-1 overflow-auto text-text dark:text-text-dark text-sm leading-relaxed"
        >
          <div class="text-center py-8 text-muted dark:text-muted-dark">Loading changelog...</div>
        </div>
      </div>
    </div>

    <!-- Units Settings Modal -->
<!-- Placeholder for remaining modal components -->


    <!-- HTML Report Modal -->
<!-- Placeholder for remaining modal components -->


    <script>
      /**
       * @fileoverview Core utility functions and constants for the EnergyPlus Dashboard
       * Provides global state management, unit conversion system, formatting functions, 
       * and application constants.
       * @author EnergyPlus Dashboard
       */

      /**
       * @namespace StorageKeys
       * @description Local storage keys for user preferences and application state
       */
      
      /** @const {string} Theme preference storage key */
      const THEME_KEY = 'eplus_theme';
      
      /** @const {string} Units system preference storage key (SI/IP) */
      const UNITS_KEY = 'eplus_units_mode';
      
      /** @const {string} Favorite signals storage key */
      const FAVORITES_KEY = 'eplus_favs';
      
      /** @const {string} Selected signals storage key */
      const SELECT_KEY = 'eplus_selected_ids';
      
      /** @const {string} Signals panel collapse state storage key */
      const COLLAPSE_KEY = 'eplus_signals_collapsed';
      
      /** @const {string} SI temperature unit preference storage key */
      const TEMP_SI_KEY = 'eplus_temp_si';
      
      /** @const {string} IP temperature unit preference storage key */
      const TEMP_IP_KEY = 'eplus_temp_ip';

      /** @const {string} SI energy unit preference storage key */
      const ENERGY_SI_KEY = 'eplus_energy_si';
      
      /** @const {string} IP energy unit preference storage key */
      const ENERGY_IP_KEY = 'eplus_energy_ip';
      
      /** @const {string} IP power unit preference storage key */
      const POWER_IP_KEY = 'eplus_power_ip';

      /**
       * @namespace GlobalState
       * @description Global application state variables for database, UI, and chart management
       */
      
      /** @type {Map<number, Object>} Currently selected signals/meters */
      let selected = new Map();
      
      /** @type {Set<number>} User's favorite signals/meters */
      let favs = new Set(JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]'));
      
      /** @type {boolean} Whether chart zooming is enabled */
      let zoomEnabled = true;
      
      /** @type {string|null} Base frequency for data resampling */
      let baseFreq = null;
      
      /** @type {string} Current chart view mode */
      let viewMode = 'time';
      
      /** @type {string} Data resampling mode */
      let resampleMode = 'original';
      
      /** @type {string} Aggregation method for resampling */
      let resampleAgg = 'auto';
      
      /** @type {Array<number>|null} Signal pair for scatter plots */
      let scatterPair = null;
      
      /** @type {boolean} Whether to show regression line in scatter plots */
      let scatterShowRegression = true;
      
      /** @type {boolean} Whether to show degree day analysis in scatter plots */
      let scatterShowDegDay = false;
      
      /** @type {number} Base temperature for degree day calculations */
      let scatterDegDayBaseTemp = 18;
      
      /** @type {string} Period for degree day calculations */
      let scatterDegDayPeriod = 'daily';
      
      /** @type {string} Degree day calculation mode */
      let scatterDegDayMode = 'both';
      
      /** @type {boolean} Whether temperature response is enabled */
      let tempRespEnabled = false;
      
      /** @type {number} Base temperature for temperature response */
      let tempRespBaseTemp = 18;
      
      /** @type {string} Period for temperature response */
      let tempRespPeriod = 'daily';
      
      /** @type {string} Temperature response mode */
      let tempRespMode = 'both';
      
      /** @type {Object|null} Temperature response model */
      let tempRespModel = null;
      
      /** @type {Array<number>|null} Current X-axis domain for charts */
      let currentXDomain = null;
      
      /** @type {boolean} Internal flag to prevent render loops */
      let __rendering = false;
      
      /** @type {Object|null} Cached load balance data */
      let __loadBalanceCache = null;

      // Units system preferences
      let isIP = localStorage.getItem(UNITS_KEY) === 'IP' ? true : false;
      let prefEnergySI = localStorage.getItem(ENERGY_SI_KEY) || 'J';
      let prefEnergyIP = localStorage.getItem(ENERGY_IP_KEY) || 'BTU';
      let prefPowerIP = localStorage.getItem(POWER_IP_KEY) || 'Btu/h';
      let prefTempSI = localStorage.getItem(TEMP_SI_KEY) || 'C';
      let prefTempIP = localStorage.getItem(TEMP_IP_KEY) || 'F';

      // Chart palette derived from Tailwind color tokens
      const palette = [
        '#1565c0', '#c62828', '#2e7d32', '#ed6c02', '#5e35b1',
        '#d81b60', '#00695c', '#ef6c00', '#1976d2', '#388e3c',
        '#f57c00', '#7b1fa2', '#c2185b', '#0097a7', '#fbc02d',
        '#455a64', '#6a1b9a', '#00796b', '#f9a825', '#424242'
      ];

      // DOM utility function
      const $ = (id) => document.getElementById(id);

      function getPreferredTheme() {
        const s = localStorage.getItem(THEME_KEY);
        return s === 'light' || s === 'dark'
          ? s
          : matchMedia('(prefers-color-scheme: dark)').matches
            ? 'dark'
            : 'light';
      }

      function escapeHtml(s) {
        return String(s).replace(
          /[&<>"']/g,
          (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' })[m],
        );
      }

      function mdToHtml(md) {
        const lines = md.split(/\r?\n/);
        let html = '',
          listOpen = false;
        for (const raw of lines) {
          const line = raw.trimEnd();
          if (!line) {
            if (listOpen) {
              html += '</ul>';
              listOpen = false;
            }
            html += '';
            continue;
          }
          if (line.startsWith('### ')) {
            if (listOpen) {
              html += '</ul>';
              listOpen = false;
            }
            html += '<h3 class="mt-4 text-sm font-semibold">' + escapeHtml(line.slice(4)) + '</h3>';
            continue;
          }
          if (line.startsWith('## ')) {
            if (listOpen) {
              html += '</ul>';
              listOpen = false;
            }
            html +=
              '<h2 class="mt-5 text-base font-semibold">' + escapeHtml(line.slice(3)) + '</h2>';
            continue;
          }
          if (line.startsWith('# ')) {
            if (listOpen) {
              html += '</ul>';
              listOpen = false;
            }
            html += '<h1 class="mt-5 text-lg font-bold">' + escapeHtml(line.slice(2)) + '</h1>';
            continue;
          }
          if (line.startsWith('- ')) {
            if (!listOpen) {
              html += '<ul class="list-disc ml-5 mt-2 space-y-1">';
              listOpen = true;
            }
            html += '<li class="text-xs">' + escapeHtml(line.slice(2)) + '</li>';
            continue;
          }
          // paragraph
          if (listOpen) {
            html += '</ul>';
            listOpen = false;
          }
          html += '<p class="text-xs leading-relaxed mt-2">' + escapeHtml(line) + '</p>';
        }
        if (listOpen) html += '</ul>';
        return html;
      }

      // Unit conversion functions
      function unitKind(units) {
        const u = String(units).toLowerCase();
        if (
          u.includes('wh') ||
          u.includes('joule') ||
          u === 'j' ||
          u.includes('kwh') ||
          u.includes('mwh')
        )
          return 'energy';
        if (
          u.includes('btu/h') ||
          u.includes('btuh') ||
          /\bw(?!h)\b/.test(u) ||
          u.includes('watt') ||
          u.includes('ton')
        )
          return 'power';
        if (
          u === 'c' ||
          u.includes('celsius') ||
          u === 'k' ||
          u.includes('kelvin') ||
          u === 'f' ||
          u.includes('fahrenheit')
        )
          return 'temperature';
        return 'other';
      }
      
      function toJoules(value, units) {
        const u = String(units || '').toLowerCase();
        if (u.includes('mwh')) return value * 3.6e9;
        if (u.includes('kwh')) return value * 3.6e6;
        if (u.includes('wh')) return value * 3600;
        if (u.includes('joule') || u === 'j') return value;
        return null;
      }

      // Fallback functions to prevent recursion
      const __orig_convertUnits = (v) => v;
      const __orig_convertUnitLabel = (u) => u || '';

      function convertUnits(value, units) {
        if (value == null || !isFinite(value)) return value;
        if (!units) return value;
        const kind = unitKind(units);
        if (isIP) {
          const u = String(units).toLowerCase();
          if (u === 'c' || u.includes('celsius')) return (value * 9) / 5 + 32;
          if (kind === 'energy') {
            let J = toJoules(value, units);
            if (J == null) J = value;
            let btu = J / 1055.06;
            if (prefEnergyIP === 'kBTU') return btu / 1e3;
            if (prefEnergyIP === 'MMBTU') return btu / 1e6;
            return btu;
          }
          if (kind === 'power') {
            let v = value;
            const ul = String(units).toLowerCase();
            if (ul.includes('w') && !ul.includes('wh')) v = value * 3.412141633;
            if (prefPowerIP === 'Tons') return v / 12000;
            return v;
          }
          if (kind === 'temperature') {
            if (prefTempIP === 'F') {
              if (/c|celsius/.test(String(units).toLowerCase())) return (value * 9) / 5 + 32;
              if (/k|kelvin/.test(String(units).toLowerCase()))
                return ((value - 273.15) * 9) / 5 + 32;
            }
            return value;
          }
          return __orig_convertUnits(value, units);
        } else {
          if (kind === 'energy') {
            let J = toJoules(value, units);
            if (J == null) J = value;
            if (prefEnergySI === 'kWh') return J / 3.6e6;
            if (prefEnergySI === 'MWh') return J / 3.6e9;
            return J;
          }
          if (kind === 'temperature') {
            const ul = String(units).toLowerCase();
            let cVal;
            if (ul === 'c' || ul.includes('celsius')) cVal = value;
            else if (ul === 'k' || ul.includes('kelvin')) cVal = value - 273.15;
            else if (ul === 'f' || ul.includes('fahrenheit')) cVal = ((value - 32) * 5) / 9;
            else cVal = value;
            if (prefTempSI === 'K') return cVal + 273.15;
            return cVal; // C
          }
          return __orig_convertUnits(value, units);
        }
      }
      
      function convertUnitLabel(units) {
        if (!units) return units || '';
        const kind = unitKind(units);
        if (isIP) {
          const u = String(units).toLowerCase();
          if (u === 'c' || u.includes('celsius')) return 'F';
          if (kind === 'energy') return prefEnergyIP;
          if (kind === 'power') return prefPowerIP === 'Tons' ? 'tons' : 'Btu/h';
          if (kind === 'temperature') return prefTempIP;
          return __orig_convertUnitLabel(units);
        } else {
          if (kind === 'energy') return prefEnergySI;
          if (kind === 'temperature') return prefTempSI;
          return __orig_convertUnitLabel(units);
        }
      }

      // Core utility functions
      function chartColors() {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        return {
          grid: isDark ? '#374151' : '#e5e7eb',
          text: isDark ? '#d1d5db' : '#374151',
          muted: isDark ? '#6b7280' : '#9ca3af',
          bg: isDark ? '#111827' : '#ffffff',
        };
      }

      function toObjects(result) {
        if (!result[0]) return [];
        const cols = result[0].columns;
        return result[0].values.map((row) => Object.fromEntries(cols.map((c, i) => [c, row[i]])));
      }

      function quantile(sorted, p) {
        if (sorted.length === 0) return null;
        const i = (sorted.length - 1) * p;
        const lower = Math.floor(i);
        const upper = Math.ceil(i);
        const w = i % 1;
        return sorted[lower] * (1 - w) + sorted[upper] * w;
      }

      function computeStats(values) {
        const finite = values.filter(isFinite);
        if (!finite.length) return { count: 0 };
        const sorted = [...finite].sort((a, b) => a - b);
        const sum = finite.reduce((a, b) => a + b, 0);
        return {
          count: finite.length,
          sum,
          mean: sum / finite.length,
          min: sorted[0],
          max: sorted[sorted.length - 1],
          q1: quantile(sorted, 0.25),
          median: quantile(sorted, 0.5),
          q3: quantile(sorted, 0.75),
        };
      }

      function fmt(n) {
        if (!isFinite(n)) return 'â€”';
        const abs = Math.abs(n);
        if (abs >= 1e9) return (n / 1e9).toFixed(1) + 'G';
        if (abs >= 1e6) return (n / 1e6).toFixed(1) + 'M';
        if (abs >= 1e3) return (n / 1e3).toFixed(1) + 'k';
        return n.toFixed(abs < 10 ? 2 : abs < 100 ? 1 : 0);
      }

      function kpiFmt(n, opts = {}) {
        if (!isFinite(n)) return 'â€”';
        const { compact = true, maxDigits = 3, forceSign = false } = opts;
        const abs = Math.abs(n);
        const sign = forceSign && n > 0 ? '+' : '';
        if (compact && abs >= 1e9) return sign + (n / 1e9).toFixed(1) + 'G';
        if (compact && abs >= 1e6) return sign + (n / 1e6).toFixed(1) + 'M';
        if (compact && abs >= 1e3) return sign + (n / 1e3).toFixed(1) + 'k';
        if (abs >= 100) return sign + n.toFixed(0);
        if (abs >= 10) return sign + n.toFixed(Math.min(1, maxDigits - 2));
        if (abs >= 1) return sign + n.toFixed(Math.min(2, maxDigits - 1));
        if (abs >= 0.1) return sign + n.toFixed(Math.min(3, maxDigits));
        if (abs >= 0.01) return sign + n.toFixed(Math.min(4, maxDigits + 1));
        return sign + n.toExponential(Math.max(0, maxDigits - 1));
      }

      function downloadFile(name, text) {
        try {
          const blob = new Blob([text], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = name;
          a.style.display = 'none';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } catch (e) {
          console.error('Download failed', e);
        }
      }

      // Library loading functionality for D3 and SQL.js
      
      function loadExternalScript(url) {
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.onload = resolve;
          script.onerror = reject;
          script.src = url;
          document.head.appendChild(script);
        });
      }

      async function ensureD3() {
        if (!window.d3) {
          const url =
            (window.__LIB_URLS__ && window.__LIB_URLS__.d3) ||
            'https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js';
          await loadExternalScript(url);
        }
      }

      let SQL;
      async function ensureSql() {
        if (SQL) return SQL;
        if (typeof window.initSqlJs !== 'function') {
          const url =
            (window.__LIB_URLS__ && window.__LIB_URLS__.sqljs) ||
            'https://cdn.jsdelivr.net/npm/sql.js@1.11.0/dist/sql-wasm.js';
          await loadExternalScript(url);
        }
        const wasmUrl =
          (window.__LIB_URLS__ && window.__LIB_URLS__.sqlwasm) ||
          'https://cdn.jsdelivr.net/npm/sql.js@1.11.0/dist/sql-wasm.wasm';
        SQL = await window.initSqlJs({ locateFile: () => wasmUrl });
        return SQL;
      }

      // Theme management functionality
      
      function applyTheme(t) {
        // Maintain legacy data-theme attribute (for remaining CSS variable usages)
        document.documentElement.setAttribute('data-theme', t);
        // Ensure Tailwind dark: variants work
        document.documentElement.classList.toggle('dark', t === 'dark');
        const b = document.getElementById('btn-theme');
        if (b) {
          b.title = `Switch to ${t === 'dark' ? 'light' : 'dark'} mode`;
          b.setAttribute('aria-label', `Switch to ${t === 'dark' ? 'light' : 'dark'} mode`);
        }
      }

      function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme');
        const newTheme = current === 'dark' ? 'light' : 'dark';
        applyTheme(newTheme);
        try {
          localStorage.setItem(THEME_KEY, newTheme);
        } catch {}
      }

      // Initialize theme
      (function initTheme() {
        const theme = getPreferredTheme();
        applyTheme(theme);
        const btn = $('btn-theme');
        if (btn) {
          btn.addEventListener('click', toggleTheme);
        }
      })();

      // Database operations and SQLite functionality
      
      let db; // Global database instance
      let dict = []; // Data dictionary cache
      let buildingAreaCache = null; // Building area cache

      async function readDbFile(file) {
        const SQLMod = await ensureSql();
        const u8 = new Uint8Array(await file.arrayBuffer());
        db = new SQLMod.Database(u8);
        return db;
      }
      
      async function readDbUrl(url) {
        const SQLMod = await ensureSql();
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error('Failed to fetch database: ' + url);
        const u8 = new Uint8Array(await res.arrayBuffer());
        db = new SQLMod.Database(u8);
        return db;
      }
      
      function queryDictionary() {
        const sql = `
      SELECT ReportDataDictionaryIndex AS id, IsMeter, Type, IndexGroup, KeyValue AS key,
             Name, ReportingFrequency AS freq, Units
      FROM ReportDataDictionary
      WHERE ReportingFrequency IN ('Hourly','Monthly')
      ORDER BY IsMeter DESC, IndexGroup, Name, key;`;
        dict = toObjects(db.exec(sql));
        // Invalidate load balance cache (new DB or changed dict)
        __loadBalanceCache = null;
        return dict;
      }
      
      function queryTimeSeries(dictId) {
        const stmt = db.prepare(`
      SELECT rd.Value AS value, t.EnvironmentPeriodIndex AS env, t.SimulationDays AS sday,
             t.Month AS month, t.Day AS day, t.Hour AS hour, t.Minute AS minute,
             t.IntervalType AS interval, t.TimeIndex AS tindex
      FROM ReportData rd JOIN Time t ON t.TimeIndex = rd.TimeIndex
      WHERE rd.ReportDataDictionaryIndex = ?
      ORDER BY t.TimeIndex;`);
        stmt.bind([dictId]);
        const rows = [];
        while (stmt.step()) rows.push(stmt.getAsObject());
        stmt.free();
        return rows;
      }

      async function getBuildingArea() {
        if (buildingAreaCache != null) return buildingAreaCache;
        try {
          // Preferred direct query (AnnualBuildingUtilityPerformanceSummary)
          try {
            const direct = db.exec(`SELECT Value AS total_building_area_m2
              FROM TabularDataWithStrings
              WHERE ReportName='AnnualBuildingUtilityPerformanceSummary'
                AND TableName='Building Area'
                AND RowName='Total Building Area'
                AND ColumnName='Area'
              LIMIT 1`);
            if (direct[0]?.values?.[0]?.[0]) {
              const area = parseFloat(direct[0].values[0][0]);
              if (area > 0) {
                buildingAreaCache = area;
                return area;
              }
            }
          } catch {}
          // Detect available columns (older sql schemas may differ)
          let hasRow = true,
            hasCol = true;
          try {
            const info = db.exec('PRAGMA table_info(TabularData)');
            const cols = new Set((info[0]?.values || []).map((r) => String(r[1]).toLowerCase()));
            hasRow = cols.has('rowname');
            hasCol = cols.has('columnname');
          } catch {}
          let q1 = [];
          if (hasRow && hasCol) {
            try {
              q1 = db.exec(
                `SELECT Value FROM TabularData WHERE (LOWER(RowName) LIKE '%net conditioned building area%' OR LOWER(RowName) LIKE '%total building area%' OR LOWER(RowName) LIKE '%building area%') AND (LOWER(ColumnName)='area' OR LOWER(ColumnName) LIKE '%m2%') LIMIT 1;`,
              );
            } catch {}
          }
          if (q1[0]?.values?.[0]?.[0]) {
            const area = parseFloat(q1[0].values[0][0]);
            if (area > 0) {
              buildingAreaCache = area;
              return area;
            }
          }
          // Fallback parse strings table if RowName exists
          if (hasRow) {
            let q2 = [];
            try {
              q2 = db.exec(
                `SELECT Value FROM TabularDataWithStrings WHERE (LOWER(RowName) LIKE '%net conditioned building area%' OR LOWER(RowName) LIKE '%total building area%' OR LOWER(RowName) LIKE '%building area%') LIMIT 10;`,
              );
            } catch {}
            if (q2[0]) {
              for (const row of q2[0].values) {
                const val = parseFloat(String(row[0]));
                if (val > 0) {
                  buildingAreaCache = val;
                  return val;
                }
              }
            }
          }
          buildingAreaCache = 0; // not found
          return 0;
        } catch (e) {
          console.warn('getBuildingArea failed', e);
          buildingAreaCache = 0;
          return 0;
        }
      }


      // Signal processing and data transformation functionality
      
      function timeLabel(r) {
        const hh = String(r.hour ?? 0).padStart(2, '0');
        const mm = String(r.minute ?? 0).padStart(2, '0');
        const md = `${String(r.month || 1).padStart(2, '0')}/${String(r.day || 1).padStart(
          2,
          '0',
        )}`;
        return `Env ${r.env} â€” ${md} ${hh}:${mm}`;
      }
      
      function toHourlyPoints(rows) {
        const year = 2000;
        return rows.map((r) => ({
          x: Date.UTC(
            year + (r.env || 0) - 1,
            (r.month || 1) - 1,
            r.day || 1,
            r.hour || 0,
            r.minute || 0,
          ),
          y: Number(r.value),
          label: timeLabel(r),
          // carry through grouping fields to avoid Date roll-over issues (e.g., hour 24)
          env: r.env || 1,
          month: r.month || 1,
          day: r.day || 1,
          hour: r.hour || 0,
          minute: r.minute || 0,
        }));
      }
      
      function toMonthlyPoints(rows) {
        return rows.map((r) => ({
          xLabel: `E${r.env}-M${String(r.month || 1).padStart(2, '0')}`,
          y: Number(r.value),
        }));
      }

      // Resampling functions for different time resolutions
      function resamplePoints(points, fromFreq, toFreq, units, aggMode = 'auto') {
        if (fromFreq === toFreq || toFreq === 'original') return points;
        if (!points || points.length === 0) return points;

        // Determine aggregation method
        let aggregateFunc = aggMode;
        if (!aggregateFunc || aggregateFunc === 'auto') {
          const isEnergy =
            units &&
            (units.toLowerCase().includes('j') ||
              units.toLowerCase().includes('wh') ||
              units.toLowerCase().includes('btu'));
          aggregateFunc = isEnergy ? 'sum' : 'avg';
        }

        if (fromFreq === 'Hourly') {
          if (toFreq === 'monthly') return resampleHourlyToMonthly(points, aggregateFunc);
          if (toFreq === 'annual') return resampleHourlyToAnnual(points, aggregateFunc);
        } else if (fromFreq === 'Monthly') {
          if (toFreq === 'annual') return resampleMonthlyToAnnual(points, aggregateFunc);
        }

        return points; // No resampling needed/supported
      }

      function resampleHourlyToMonthly(points, aggregateFunc) {
        const groups = new Map(); // key: E{env}-M{mm}
        for (const p of points) {
          const date = new Date(p.x);
          const env = p.env || 1;
          const month = date.getUTCMonth() + 1;
          const key = `E${env}-M${String(month).padStart(2, '0')}`;
          let g = groups.get(key);
          if (!g) {
            g = { values: [], xLabel: key, env, month };
            groups.set(key, g);
          }
          g.values.push(p.y);
        }
        const result = [];
        for (const [key, g] of groups) {
          let y;
          if (aggregateFunc === 'sum') y = g.values.reduce((a, b) => a + b, 0);
          else if (aggregateFunc === 'max') y = Math.max(...g.values);
          else if (aggregateFunc === 'min') y = Math.min(...g.values);
          else y = g.values.reduce((a, b) => a + b, 0) / g.values.length; // avg
          result.push({ xLabel: key, y, env: g.env, month: g.month });
        }
        return result.sort((a, b) => a.env - b.env || a.month - b.month);
      }

      function resampleMonthlyToAnnual(points, aggregateFunc) {
        const groups = new Map();
        for (const p of points) {
          let env = p.env;
          if (p.xLabel && p.xLabel.startsWith('E')) {
            env = parseInt(p.xLabel.slice(1).split('-')[0]) || 1;
          }
          const key = `E${env}`;
          let g = groups.get(key);
          if (!g) {
            g = { values: [], xLabel: key, env };
            groups.set(key, g);
          }
          g.values.push(p.y);
        }
        const result = [];
        for (const [key, g] of groups) {
          let y;
          if (aggregateFunc === 'sum') y = g.values.reduce((a, b) => a + b, 0);
          else if (aggregateFunc === 'max') y = Math.max(...g.values);
          else if (aggregateFunc === 'min') y = Math.min(...g.values);
          else y = g.values.reduce((a, b) => a + b, 0) / g.values.length; // avg
          result.push({ xLabel: key, y, env: g.env });
        }
        return result.sort((a, b) => a.env - b.env);
      }

      function resampleHourlyToAnnual(points, aggregateFunc) {
        // Group by environment period first
        const groups = new Map();
        for (const p of points) {
          const env = p.env || 1;
          const key = `E${env}`;
          let g = groups.get(key);
          if (!g) {
            g = { values: [], xLabel: key, env };
            groups.set(key, g);
          }
          g.values.push(p.y);
        }
        const result = [];
        for (const [key, g] of groups) {
          let y;
          if (aggregateFunc === 'sum') y = g.values.reduce((a, b) => a + b, 0);
          else if (aggregateFunc === 'max') y = Math.max(...g.values);
          else if (aggregateFunc === 'min') y = Math.min(...g.values);
          else y = g.values.reduce((a, b) => a + b, 0) / g.values.length; // avg
          result.push({ xLabel: key, y, env: g.env });
        }
        return result.sort((a, b) => a.env - b.env);
      }


      /**
       * @fileoverview Data export functionality for CSV generation
       * Provides CSV export capabilities for selected time series data
       * @author EnergyPlus Dashboard
       */

      /**
       * Export selected time series data as CSV format
       * @param {Map<number, Object>} selectedSeries - Map of selected signal IDs to their data
       * @returns {string} CSV formatted string
       */
      function exportCSV(selectedSeries) {
        if (!selectedSeries || selectedSeries.size === 0) {
          return 'No data selected for export';
        }

        try {
          // Get all selected series data
          const series = Array.from(selectedSeries.values());
          
          // Find the maximum length of data across all series
          let maxLength = 0;
          series.forEach(s => {
            if (s.data && s.data.length > maxLength) {
              maxLength = s.data.length;
            }
          });

          if (maxLength === 0) {
            return 'No time series data available for export';
          }

          // Build CSV header
          const headers = ['Timestamp'];
          series.forEach(s => {
            const units = convertUnitLabel(s.units) || s.units || '';
            const label = units ? `${s.name} (${units})` : s.name;
            headers.push(label);
          });

          // Build CSV rows
          const rows = [headers.join(',')];
          
          for (let i = 0; i < maxLength; i++) {
            const row = [];
            
            // Add timestamp (use first series' timestamp)
            const timestamp = series[0].data && series[0].data[i] ? series[0].data[i].timestamp : '';
            row.push(timestamp);
            
            // Add values for each series
            series.forEach(s => {
              let value = '';
              if (s.data && s.data[i]) {
                const rawValue = s.data[i].value;
                if (rawValue != null && isFinite(rawValue)) {
                  const convertedValue = convertUnits(rawValue, s.units);
                  value = convertedValue != null ? convertedValue : rawValue;
                }
              }
              row.push(value);
            });
            
            rows.push(row.join(','));
          }

          return rows.join('\\n');
          
        } catch (error) {
          console.error('CSV export failed:', error);
          return 'Error: Failed to export CSV data - ' + (error.message || String(error));
        }
      }


      // Modal management functionality
      
      function showChangelog() {
        const backdrop = document.getElementById('changelog-backdrop');
        const modal = document.getElementById('changelog-modal');
        if (!backdrop || !modal) return;
        backdrop.classList.remove('hidden');
        modal.classList.remove('hidden');
        // Load only once
        const body = document.getElementById('changelog-body');
        if (body && !body.dataset.loaded) {
          const embed =
            window.__CHANGELOG_MD__ && typeof window.__CHANGELOG_MD__ === 'string'
              ? window.__CHANGELOG_MD__
              : null;
          const ghOwner = 'samuelduchesne';
          const ghRepo = 'eplusout-dashboard';
          const branch = 'main';
          const ghUrl = `https://raw.githubusercontent.com/${ghOwner}/${ghRepo}/${branch}/CHANGELOG.md`;
          const loadRemote = () =>
            fetch(ghUrl, { cache: 'no-store' }).then((r) => (r.ok ? r.text() : Promise.reject()));
          const loadLocal = () =>
            fetch('CHANGELOG.md').then((r) => (r.ok ? r.text() : Promise.reject()));
          const render = (txt) => {
            body.innerHTML = mdToHtml(txt);
            body.dataset.loaded = '1';
          };
          if (embed) {
            render(embed);
          } else {
            loadRemote()
              .catch(() =>
                location.protocol === 'file:' ? Promise.reject('file-scheme') : loadLocal(),
              )
              .then(render)
              .catch((err) => {
                if (err === 'file-scheme') {
                  body.innerHTML =
                    '<p class="text-xs text-muted dark:text-muted-dark">Open via a local web server to auto-fetch the changelog (e.g. <code>python -m http.server</code>). Or ensure it is embedded at build.</p>';
                } else {
                  // final fallback: show minimal guidance
                  body.innerHTML =
                    '<p class="text-xs text-danger dark:text-danger-dark">Changelog unavailable.</p>';
                }
              });
          }
        }
        modal.focus();
      }

      function hideChangelog() {
        document.getElementById('changelog-backdrop')?.classList.add('hidden');
        document.getElementById('changelog-modal')?.classList.add('hidden');
      }

      function showHtmlReport() {
        const backdrop = document.getElementById('html-report-backdrop');
        const modal = document.getElementById('html-report-modal');
        if (!backdrop || !modal) return;
        backdrop.classList.remove('hidden');
        modal.classList.remove('hidden');
        // Generate report content would be called here
        // generateHtmlReport();
        modal.focus();
      }

      function hideHtmlReport() {
        document.getElementById('html-report-backdrop')?.classList.add('hidden');
        document.getElementById('html-report-modal')?.classList.add('hidden');
      }

      // Global modal event handlers
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          hideChangelog();
          hideHtmlReport();
        }
      });

      document.addEventListener('click', (e) => {
        if (e.target.id === 'changelog-backdrop') hideChangelog();
        if (e.target.id === 'html-report-backdrop') hideHtmlReport();
      });

      // Initialize modal triggers
      document.getElementById('app-version')?.addEventListener('click', showChangelog);
      document.getElementById('btn-html-report')?.addEventListener('click', showHtmlReport);

      // UI filters and data dictionary management
      
      function populateFilters(list) {
        const groups = Array.from(new Set(list.map((d) => d.IndexGroup).filter(Boolean))).sort();
        const gSel = $('filter-group');
        if (gSel) {
          gSel.innerHTML =
            `<option value="">Any index group</option>` +
            groups.map((g) => `<option>${escapeHtml(g)}</option>`).join('');
        }
        ['search', 'filter-freq', 'filter-meter', 'filter-group', 'dictionary', 'fav-only'].forEach(
          (id) => {
            const el = $(id);
            if (el) el.disabled = false;
          }
        );
        const countEl = $('meta-count');
        if (countEl) countEl.textContent = `${list.length} entries`;
      }

      function populateDictionaryList() {
        const q = ($('search')?.value || '').trim().toLowerCase();
        const fFreq = $('filter-freq')?.value || '';
        const fMeter = $('filter-meter')?.value || '';
        const fGroup = $('filter-group')?.value || '';
        const onlyFav = $('fav-only')?.checked || false;
        
        const filtered = dict.filter((d) => {
          if (fFreq && d.freq !== fFreq) return false;
          if (fMeter !== '' && String(d.IsMeter) !== fMeter) return false;
          if (fGroup && d.IndexGroup !== fGroup) return false;
          if (onlyFav && !favs.has(d.id)) return false;
          const hay = `${d.Name} ${d.IndexGroup || ''} ${d.key || ''} ${
            d.Units || ''
          }`.toLowerCase();
          return !q || hay.includes(q);
        });
        
        const sel = $('dictionary');
        if (sel) {
          sel.innerHTML = filtered
            .map((d) => {
              const star = favs.has(d.id) ? 'â˜… ' : '';
              const tag = d.IsMeter ? 'M' : 'V';
              const units = d.Units ? ` [${escapeHtml(convertUnitLabel(d.Units))}]` : '';
              const key = d.key ? ` (${escapeHtml(d.key)})` : '';
              const label = `${star}${d.freq} | ${d.IndexGroup || 'â€”'} | [${tag}] ${escapeHtml(
                d.Name,
              )}${key}${units}`;
              return `<option value="${d.id}">${label}</option>`;
            })
            .join('');
        }
        
        const countEl = $('meta-count');
        if (countEl) countEl.textContent = `${filtered.length} / ${dict.length}`;
      }

      function populateZoneQuick() {
        // Placeholder for zone quick-select functionality
        console.log('[filters] populateZoneQuick called');
      }

      // Handle selection changes in the dictionary
      function handleSelectionChange() {
        try {
          const sel = $('dictionary');
          if (!sel) return;
          
          const chosen = Array.from(sel.selectedOptions).map((opt) => parseInt(opt.value));
          if (chosen.length === 0) {
            selected.clear();
            baseFreq = null;
            currentXDomain = null;
            renderAll();
            return;
          }
          
          const first = dict.find((d) => d.id === chosen[0]);
          const newFreq = first?.freq || 'Hourly';
          if (newFreq !== baseFreq) currentXDomain = null;
          baseFreq = newFreq;
          
          for (const id of chosen) {
            const meta = dict.find((d) => d.id === id);
            if (!meta || meta.freq !== baseFreq) continue;
            if (!selected.has(id)) {
              const rows = queryTimeSeries(id);
              const pts = baseFreq === 'Hourly' ? toHourlyPoints(rows) : toMonthlyPoints(rows);
              selected.set(id, { meta, points: pts, visible: true });
            }
          }
          
          for (const id of [...selected.keys()]) {
            if (!chosen.includes(id)) selected.delete(id);
          }
          
          renderAll();
        } catch (e) {
          console.error('Selection change failed', e);
        }
      }

      function restoreSelection() {
        try {
          const stored = JSON.parse(localStorage.getItem(SELECT_KEY) || '[]');
          if (Array.isArray(stored) && stored.length > 0) {
            const sel = $('dictionary');
            if (sel) {
              Array.from(sel.options).forEach((opt) => {
                opt.selected = stored.includes(parseInt(opt.value));
              });
              handleSelectionChange();
            }
          }
        } catch (e) {
          console.warn('Selection restore failed', e);
        }
      }


      // Chart rendering and theme management
      
      function refreshChartTheme() {
        if (selected.size === 0) return;
        renderAll();
      }

      // Placeholder renderAll function - to be replaced with full implementation
      function renderAll() {
        if (__rendering) return; // prevent re-entrant recursive calls
        __rendering = true;
        try {
          console.log('[charts] renderAll called - basic placeholder implementation');
          // Basic implementation for now
          const metaEl = $('series-meta-entries');
          const unitsEl = $('units');
          const titleEl = $('series-title');
          
          if (metaEl) metaEl.innerHTML = 'Charts module loaded - basic implementation';
          if (unitsEl) unitsEl.textContent = '';
          if (titleEl) titleEl.textContent = 'Dashboard Ready';
          
        } catch (e) {
          console.error('renderAll failed:', e);
        } finally {
          __rendering = false;
        }
      }

      // Placeholder for additional chart functions
      async function renderChart(series, opts = {}) {
        console.log('[charts] renderChart called with', series.length, 'series');
      }

      async function renderLDC(series) {
        console.log('[charts] renderLDC called');
      }

      async function renderLoadBalance(series) {
        console.log('[charts] renderLoadBalance called');
      }

      function renderScatter(series) {
        console.log('[charts] renderScatter called');
      }

      function renderInsights(series, targetEl) {
        console.log('[charts] renderInsights called');
      }

      function renderStats(series, targetEl) {
        console.log('[charts] renderStats called');
      }

      async function renderKPIs(series) {
        console.log('[charts] renderKPIs called');
      }


// Placeholder modules for demonstration


      /**
       * @fileoverview File handling functionality for database loading
       * Provides file input, drag-and-drop, and database opening capabilities
       * @author EnergyPlus Dashboard
       */

      /**
       * Show the file opening modal
       */
      function showOpen() {
        const modal = $('open-modal');
        const backdrop = $('open-backdrop');
        const mainGrid = $('main-grid');
        
        if (modal) modal.classList.remove('hidden');
        if (backdrop) backdrop.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
        if (mainGrid) mainGrid.setAttribute('inert', '');
        
        // Ensure dropzone is initialized
        const dropZone = $('open-drop');
        if (dropZone) enableDropZone(dropZone);
      }

      /**
       * Hide the file opening modal
       */
      function hideOpen() {
        const modal = $('open-modal');
        const backdrop = $('open-backdrop');
        const mainGrid = $('main-grid');
        
        if (modal) modal.classList.add('hidden');
        if (backdrop) backdrop.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
        if (mainGrid) mainGrid.removeAttribute('inert');
      }

      /**
       * Enable drag and drop functionality for a drop zone element
       * @param {HTMLElement} el - The drop zone element
       */
      function enableDropZone(el) {
        if (!el) return;
        
        const highlight = () =>
          el.classList.add(
            'ring-2',
            'ring-accent',
            'dark:ring-accent-dark',
            'ring-offset-2',
            'ring-offset-panel',
            'dark:ring-offset-panel-dark',
          );
        
        const unhighlight = () =>
          el.classList.remove(
            'ring-2',
            'ring-accent',
            'dark:ring-accent-dark',
            'ring-offset-2',
            'ring-offset-panel',
            'dark:ring-offset-panel-dark',
          );
        
        ['dragenter', 'dragover'].forEach((evt) =>
          el.addEventListener(evt, (e) => {
            e.preventDefault();
            e.stopPropagation();
            highlight();
          }),
        );
        
        ['dragleave', 'drop'].forEach((evt) =>
          el.addEventListener(evt, (e) => {
            e.preventDefault();
            e.stopPropagation();
            unhighlight();
          }),
        );
        
        el.addEventListener('drop', async (e) => {
          const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
          if (f) {
            try {
              await handleFile(f);
              hideOpen();
            } catch (err) {
              console.warn('Drop file load failed', err);
              alert('Failed to open database: ' + (err && err.message ? err.message : String(err)));
            }
          }
        });
      }

      /**
       * Handle file input change events
       * @param {Event} e - The change event
       */
      async function handleFileInputChange(e) {
        try {
          const f = e.target.files && e.target.files[0];
          if (!f) return; // cancelled
          await handleFile(f);
          hideOpen();
        } catch (err) {
          console.warn('File load failed', err);
          alert('Failed to open database: ' + (err && err.message ? err.message : String(err)));
        }
      }

      /**
       * Setup file handling event listeners
       */
      function setupFileHandling() {
        // Open button
        const btnOpen = $('btn-open');
        if (btnOpen) {
          btnOpen.addEventListener('click', showOpen);
        }

        // Modal close handlers
        const openClose = $('open-close');
        const openBackdrop = $('open-backdrop');
        if (openClose) openClose.addEventListener('click', hideOpen);
        if (openBackdrop) openBackdrop.addEventListener('click', hideOpen);

        // File input handlers
        const fileInput = $('file-input');
        if (fileInput) {
          fileInput.addEventListener('click', (e) => {
            // Ensure same-file re-selection triggers change on all browsers
            try {
              e.target.value = '';
            } catch {}
          });
          fileInput.addEventListener('change', handleFileInputChange);
        }

        // Load sample button
        const btnLoadSample = $('open-load-sample');
        if (btnLoadSample) {
          btnLoadSample.addEventListener('click', async () => {
            try {
              await readDbUrl('dist/eplusout.sql');
              try {
                await ensureD3();
              } catch (e) {
                console.warn('d3 preload failed', e);
              }
              const list = queryDictionary();
              populateFilters(list);
              populateDictionaryList();
              populateZoneQuick();
              restoreSelection();
              const btnHtmlReport = $('btn-html-report');
              if (btnHtmlReport) btnHtmlReport.disabled = false;
              if (selected.size === 0 && list.length) {
                const firstMeter = list.find((d) => d.IsMeter == 1) || list[0];
                if (firstMeter) {
                  const sel = $('dictionary');
                  if (sel) {
                    for (const option of sel.options) {
                      option.selected = Number(option.value) === firstMeter.id;
                    }
                    handleSelectionChange();
                  }
                }
              }
              hideOpen();
            } catch (err) {
              console.error('Sample load failed', err);
              alert('Failed to load sample: ' + (err?.message || String(err)));
            }
          });
        }

        // Initialize dropzone for existing modal
        const dropZone = $('open-drop');
        if (dropZone) enableDropZone(dropZone);

        // Global body drag-and-drop
        enableBodyDropZone();
      }

      /**
       * Enable drag and drop on the entire body for convenience
       */
      function enableBodyDropZone() {
        document.body.addEventListener('dragover', (e) => {
          e.preventDefault();
        });

        document.body.addEventListener('drop', async (e) => {
          e.preventDefault();
          const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
          if (f && f.name.match(/\.(sql|sqlite|db)$/i)) {
            try {
              await handleFile(f);
            } catch (err) {
              console.warn('Body drop file load failed', err);
              alert('Failed to open database: ' + (err && err.message ? err.message : String(err)));
            }
          }
        });
      }

      /**
       * @fileoverview Additional UI event handlers for main application buttons
       * Provides export functionality and other missing event handlers
       * @author EnergyPlus Dashboard
       */

      /**
       * Export selected data as CSV
       */
      function handleExport() {
        if (selected.size === 0) return;
        downloadFile('series.csv', exportCSV(selected));
      }

      /**
       * Handle dictionary double-click for favorites
       * @param {Event} e - The double-click event
       */
      function handleDictionaryDoubleClick(e) {
        const sel = $('dictionary');
        const opt = sel.selectedOptions[0];
        if (!opt) return;
        const id = Number(opt.value);
        if (favs.has(id)) favs.delete(id);
        else favs.add(id);
        localStorage.setItem(FAVORITES_KEY, JSON.stringify([...favs]));
        populateDictionaryList();
      }

      /**
       * Setup additional UI event handlers
       */
      function setupAdditionalEventHandlers() {
        // Export button
        const btnExport = $('btn-export');
        if (btnExport) {
          btnExport.addEventListener('click', handleExport);
        }

        // Dictionary double-click for favorites
        const dictionary = $('dictionary');
        if (dictionary) {
          dictionary.addEventListener('dblclick', handleDictionaryDoubleClick);
        }

        // Enable theme toggle if it exists
        const themeToggle = $('theme-toggle');
        if (themeToggle) {
          themeToggle.addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme') || 'light';
            const next = current === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem(THEME_KEY, next);
          });
        }

        // Enable units settings if they exist
        const unitsSettings = ['energy-si', 'energy-ip', 'power-ip', 'temp-si', 'temp-ip'];
        unitsSettings.forEach(id => {
          const el = $(id);
          if (el) {
            el.addEventListener('change', () => {
              // Update unit preferences based on setting changes
              if (id === 'energy-si') prefEnergySI = el.value;
              if (id === 'energy-ip') prefEnergyIP = el.value;
              if (id === 'power-ip') prefPowerIP = el.value;
              if (id === 'temp-si') prefTempSI = el.value;
              if (id === 'temp-ip') prefTempIP = el.value;
              
              // Save to localStorage
              localStorage.setItem(id.replace('-', '_').toUpperCase() + '_KEY', el.value);
              
              // Re-render if data is loaded
              if (selected.size > 0) {
                renderAll();
              }
            });
          }
        });
      }

      // Application initialization and setup
      
      // Core file handling function
      async function handleFile(file) {
        await readDbFile(file);
        // Preload D3 early to avoid race when first render triggers before script loads
        try {
          await ensureD3();
        } catch (e) {
          console.warn('d3 preload failed', e);
        }
        const list = queryDictionary();
        populateFilters(list);
        populateDictionaryList();
        populateZoneQuick();
        restoreSelection();
        // Enable HTML report button now that database is loaded
        const btnHtmlReport = $('btn-html-report');
        if (btnHtmlReport) btnHtmlReport.disabled = false;
        // If nothing selected from previous session, auto-select the first meter
        if (selected.size === 0) {
          const firstMeter = list.find((d) => d.IsMeter == 1);
          if (firstMeter) {
            const sel = $('dictionary');
            if (sel) {
              for (const option of sel.options) {
                if (Number(option.value) === firstMeter.id) {
                  option.selected = true;
                  break;
                }
              }
              handleSelectionChange();
            }
          }
        }
      }

      // Setup event listeners for UI controls
      function setupEventListeners() {
        // Dictionary selection
        const dictionary = $('dictionary');
        if (dictionary) {
          dictionary.addEventListener('change', handleSelectionChange);
        }

        // Filter controls
        const filters = ['search', 'filter-freq', 'filter-meter', 'filter-group', 'fav-only'];
        filters.forEach(id => {
          const el = $(id);
          if (el) {
            el.addEventListener('change', populateDictionaryList);
            if (el.tagName === 'INPUT') {
              el.addEventListener('input', populateDictionaryList);
            }
          }
        });

        // Units toggle
        const btnUnits = $('btn-units');
        if (btnUnits) {
          btnUnits.textContent = isIP ? 'IP' : 'SI';
          btnUnits.addEventListener('click', () => {
            isIP = !isIP;
            btnUnits.textContent = isIP ? 'IP' : 'SI';
            localStorage.setItem(UNITS_KEY, isIP ? 'IP' : 'SI');
            renderAll();
          });
        }

        // View mode buttons
        const viewButtons = [
          { id: 'btn-time', mode: 'time' },
          { id: 'btn-ldc', mode: 'ldc' },
          { id: 'btn-balance', mode: 'balance' },
          { id: 'btn-scatter', mode: 'scatter' }
        ];

        viewButtons.forEach(({ id, mode }) => {
          const btn = $(id);
          if (btn) {
            btn.addEventListener('click', () => {
              viewMode = mode;
              // Update button states
              viewButtons.forEach(({ id: otherId }) => {
                const otherBtn = $(otherId);
                if (otherBtn) {
                  if (otherId === id) {
                    otherBtn.classList.add('bg-panel-2', 'dark:bg-panel-2-dark');
                  } else {
                    otherBtn.classList.remove('bg-panel-2', 'dark:bg-panel-2-dark');
                  }
                }
              });
              renderAll();
            });
          }
        });

        // Load sample button
        const btnLoadSample = $('btn-load-sample');
        if (btnLoadSample) {
          btnLoadSample.addEventListener('click', async () => {
            try {
              await readDbUrl('dist/eplusout.sql');
              try {
                await ensureD3();
              } catch (e) {
                console.warn('d3 preload failed', e);
              }
              const list = queryDictionary();
              populateFilters(list);
              populateDictionaryList();
              populateZoneQuick();
              restoreSelection();
              const btnHtmlReport = $('btn-html-report');
              if (btnHtmlReport) btnHtmlReport.disabled = false;
              if (selected.size === 0 && list.length) {
                const firstMeter = list.find((d) => d.IsMeter == 1) || list[0];
                if (firstMeter) {
                  const sel = $('dictionary');
                  if (sel) {
                    for (const option of sel.options) {
                      option.selected = Number(option.value) === firstMeter.id;
                    }
                    handleSelectionChange();
                  }
                }
              }
              // Close modal after loading
              const modal = $('open-modal');
              if (modal) modal.classList.add('hidden');
            } catch (err) {
              console.error('Sample load failed', err);
              alert('Failed to load sample: ' + (err?.message || String(err)));
            }
          });
        }
      }

      // Inject app version (fallback to hardcoded package.json version if no build replacement)
      (function setAppVersion() {
        try {
          const v = window.__APP_VERSION__ || '0.0.1';
          const el = document.getElementById('app-version');
          if (el) el.textContent = 'v' + v;
        } catch {}
      })();

      // New Issue launcher
      (function setupIssueButton() {
        const btn = document.getElementById('btn-report');
        if (!btn) return;
        btn.addEventListener('click', () => {
          try {
            const ghOwner = 'samuelduchesne';
            const ghRepo = 'eplusout-dashboard';
            const version = (window.__APP_VERSION__ || '').trim() || 'dev';
            const theme = document.documentElement.getAttribute('data-theme') || '';
            const units = localStorage.getItem('eplus_units_mode') || 'SI';
            const browser = navigator.userAgent;
            const body = encodeURIComponent(`**Version:** ${version}
**Theme:** ${theme}
**Units:** ${units}
**Browser:** ${browser}

**Issue Description:**

(Please describe your issue or feature request here)`);
            const url = `https://github.com/${ghOwner}/${ghRepo}/issues/new?body=${body}`;
            window.open(url, '_blank');
          } catch (e) {
            console.warn('Failed to open issue URL', e);
          }
        });
      })();

      // Initialize the application
      function initializeApp() {
        console.log('[app] Initializing EnergyPlus Dashboard');
        setupEventListeners();
        setupFileHandling();
        setupAdditionalEventHandlers();
        
        // Set initial view mode
        const btnTime = $('btn-time');
        if (btnTime) {
          btnTime.classList.add('bg-panel-2', 'dark:bg-panel-2-dark');
        }
        
        console.log('[app] Application initialized successfully');
      }

      // Auto-initialize when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
      } else {
        initializeApp();
      }
    </script>
  </body>
</html>